@page
@model CompanyWebpages.Pages.EmployeeDashboardModel
@using gategourmetLibrary.Models

@{
    ViewData["Title"] = "Employee Dashboard";
}

<h2 class="mb-2" style="font-family:'Playfair Display',serif;">My tasks</h2>
<p class="text-muted mb-3">
    Here you can see your assigned recipe parts, mark them as done and update where they are stored
    (freezer, fridge or dry storage).
</p>

@{
    // check if there are any tasks without a registered warehouse location
    bool hasUnassigned = false;

    if (Model.Tasks != null)
    {
        foreach (EmployeeTask t in Model.Tasks)
        {
            if (t.Location == "Not registered")
            {
                hasUnassigned = true;
                break;
            }
        }
    }
}

@if (hasUnassigned)
{
    <div class="alert alert-warning mb-3">
        Some tasks do not have a storage location yet.
        Please assign a freezer, fridge or dry storage before the order is sent.
    </div>
}

<div class="table-responsive">
    <table class="table align-middle shadow-sm text-white">
        <thead>
            <tr>
                <th style="width: 8%">Order</th>
                <th style="width: 28%">Task</th>
                <th style="width: 18%">Location</th>
                <th style="width: 14%">Status</th>
                <th style="width: 16%">Actions</th>
                <th style="width: 16%">Storage</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Tasks != null && Model.Tasks.Any())
            {
                foreach (EmployeeTask task in Model.Tasks)
                {
                    <tr>
                        <td>@task.OrderId</td>

                        <td>
                            <div class="fw-semibold">@task.TaskName</div>
                            <div class="text-muted small">Recipe part ID: @task.RecipePartId</div>
                        </td>

                        <td>
                            @* show colored badge based on warehouse type *@
                            @if (task.Location == "Freezer")
                            {
                                <span class="badge bg-primary px-3">Freezer</span>
                            }
                            else if (task.Location == "Fridge")
                            {
                                <span class="badge bg-success px-3">Fridge</span>
                            }
                            else if (task.Location == "Dry")
                            {
                                <span class="badge bg-warning text-dark px-3">Dry</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary px-3">Not registered</span>
                            }
                        </td>

                        <td>
                            @if (task.IsCompleted)
                            {
                                <span class="badge bg-success px-3">Completed</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark px-3">In progress</span>
                            }
                        </td>

                        <td>
                            @if (!task.IsCompleted)
                            {
                                <form method="post" asp-page-handler="MarkDone" class="d-inline">
                                    <input type="hidden" name="orderId" value="@task.OrderId" />
                                    <input type="hidden" name="recipePartId" value="@task.RecipePartId" />
                                    <button type="submit" class="btn btn-sm btn-success">
                                        Mark done
                                    </button>
                                </form>
                            }
                            else
                            {
                                <span class="text-muted small">No actions</span>
                            }
                        </td>

                        @* inline dropdown to update storage location for this recipe part *@
                        <td>
                            <form method="post" asp-page-handler="UpdateLocation" class="d-flex">
                                <!-- which recipe part to update -->
                                <input type="hidden" name="recipePartId" value="@task.RecipePartId" />

                                <select name="selectedWarehouseId"
                                        class="form-select form-select-sm me-2">
                                    <option value="">-- Select warehouse --</option>

                                    @foreach (Warehouse w in Model.Warehouses)
                                    {
                                        string selected = task.Location == w.Type.ToString() ? "selected" : "";

                                        <option value="@w.ID" selected="@selected">
                                            @w.Type.ToString() – @w.Location
                                        </option>
                                    }
                                </select>

                                <button type="submit" class="btn btn-sm btn-outline-info">
                                    Update
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-muted">
                        No tasks assigned.
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
